<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Enact Formmatter</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <style>
            #drop-area {
                color: #0f3c4b;
                background-color: floralwhite;
                outline: 2px dashed #0f3c4b;
                outline-offset: -12px;
                transition: outline-offset 0.2s ease-out, outline-color 0.3s ease-in-out, background-color 0.2s ease-out;
            }
            #drop-area.highlight {
                border-color: purple;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <main>
                <div class="py-5 g-5">
                    <form>
                        <fieldset id="drop-area" class="text-center mb-3 p-4">
                            <p class="small my-2">Drag &amp; Drop CSV file here<br><i>or</i></p>
                            <input id="selectCsvFile" class="position-absolute invisible" type="file" accept=".csv" />
                            <label class="btn btn-primary mb-3" for="selectCsvFile">Choose CSV file</label>
                        </fieldset>
                    </form>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="m-0">NIH Enrollment</h6>
                            <nav class="navbar navbar-expand-sm m-0 p-0">
                                <div class="container-fluid">
                                    <div class="input-group flex-nowrap me-3">
                                        <label class="form-label m-1 me-2" for="data-format">Data Format:</label>
                                        <select class="form-select form-select-sm" id="data-format">
                                            <option value="csv" selected="selected">CSV</option>
                                        </select>
                                    </div>
                                    <div class="collapse navbar-collapse">
                                        <ul class="navbar-nav">
                                            <li class="nav-item">
                                                <a class="nav-link active" id="exportData" aria-current="page" href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-placement="top" title="Export to file">
                                                    <i class="bi bi-file-arrow-down" aria-hidden="true"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </nav>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm m-0" id="enrollments">
                                <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col" colspan="3" class="table-primary">Not Hispanic or Latino</th>
                                        <th scope="col" colspan="3" class="table-success">Hispanic or Latino</th>
                                        <th scope="col" colspan="3" class="table-info">Unknown/Not Reported Ethnicity</th>
                                    </tr>
                                    <tr>
                                        <th scope="col">Racial Category</th>
                                        <th scope="col" class="table-primary">Female</th>
                                        <th scope="col" class="table-primary">Male</th>
                                        <th scope="col" class="table-primary">Unknown/Not Reported</th>
                                        <th scope="col" class="table-success">Female</th>
                                        <th scope="col" class="table-success">Male</th>
                                        <th scope="col" class="table-success">Unknown/Not Reported</th>
                                        <th scope="col" class="table-info">Female</th>
                                        <th scope="col" class="table-info">Male</th>
                                        <th scope="col" class="table-info">Unknown/Not Reported</th>
                                    </tr>
                                </thead>
                                <tbody class="table-group-divider">
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script>
            const enrollments = new Map();

            let dropArea = document.getElementById('drop-area');

            function preventDefaults(evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }

            function highlight(e) {
                dropArea.classList.add('highlight');
            }
            function unhighlight(e) {
                dropArea.classList.remove('highlight');
            }

            function exportAsCSV() {
                const headers = [
                    'Racial Category',
                    'Female (Not Hispanic)',
                    'Male (Not Hispanic)',
                    'Unknown/Not Reported (Not Hispanic)',
                    'Female (Hispanic)',
                    'Male (Hispanic)',
                    'Unknown/Not Reported (Hispanic)',
                    'Female (Unknown/Not Reported Ethnicity)',
                    'Male (Unknown/Not Reported Ethnicity)',
                    'Unknown/Not Reported (Unknown/Not Reported Ethnicity)'
                ];

                const rowData = [];
                rowData.push(headers.join(','));

                enrollments.forEach((values, keys) => {
                    rowData.push(values.join(','));
                });

                return rowData.join('\r\n');
            }

            function exportToFile() {
                const select = document.getElementById('data-format');
                const fileType = select.options[select.selectedIndex].value;
                if (fileType === 'csv') {
                    const strData = exportAsCSV();
                    let blob = new Blob([strData], {type: 'text/csv;charset=utf-8;'});

                    const downloadLink = document.createElement("a");
                    downloadLink.download = 'nih_enrollment.csv';
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.click();
                }

            }

            function getCounts(data) {
                return counts = data
                        .filter(num => num !== '')
                        .map(num => parseInt(num))
                        .reduce((accumulator, currentValue) => accumulator + currentValue);
            }

            function processFile(csvFile) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const text = evt.target.result;
                    const lines = text.split('\n')
                            .map(line => line.trim())
                            .filter(line => line !== '')
                            .slice(2)
                            .forEach(line => {
                                const data = line.split(',')
                                        .map(line => line.trim())
                                        .filter(line => line !== '')
                                        .map(line => (line === 'unavailable') ? "0" : line)
                                        .map(line => (line === '10 patients or fewer') ? "10" : line);

                                const counts = getCounts(data.slice(1));

                                const category = data[0].replace('NIH Enrollment', '').trim();
                                const categories = category.split('-');
                                const race = categories[0]
                                        .replace('Multiple race', 'More than One Race')
                                        .replace('No Race Info', 'Unknown or Not Reported');
                                const gender = categories[1].toLowerCase();
                                const ethnicity = categories[2].toLowerCase();

                                if (!enrollments.has(race)) {
                                    const enrollment = Array(10).fill(0);
                                    enrollment[0] = race;
                                    enrollments.set(race, enrollment);
                                }
                                let enrollment = enrollments.get(race);
                                if (ethnicity === 'not hispanic') {
                                    if (gender === 'female') {
                                        enrollment[1] = counts;
                                    } else if (gender === 'male') {
                                        enrollment[2] = counts;
                                    } else {
                                        enrollment[3] = counts;
                                    }
                                } else if (ethnicity === 'hispanic') {
                                    if (gender === 'female') {
                                        enrollment[4] = counts;
                                    } else if (gender === 'male') {
                                        enrollment[5] = counts;
                                    } else {
                                        enrollment[6] = counts;
                                    }
                                } else {
                                    if (gender === 'female') {
                                        enrollment[7] = counts;
                                    } else if (gender === 'male') {
                                        enrollment[8] = counts;
                                    } else {
                                        enrollment[9] = counts;
                                    }
                                }
                            });

                    const enrollmentTable = document.getElementById('enrollments');
                    const tbody = enrollmentTable.getElementsByTagName('tbody')[0];
                    enrollments.forEach((values, keys) => {
                        const columns = [];
                        const row = tbody.insertRow(-1);
                        for (let i = 0; i < values.length; i++) {
                            columns[i] = row.insertCell(i);
                            if (i === 0) {
                                columns[i].outerHTML = `<th scope="row">${values[i]}</th>`;
                            } else {
                                columns[i].innerHTML = values[i];
                            }

                        }

                        // add background color
                        columns[1].classList.add('table-primary');
                        columns[2].classList.add('table-primary');
                        columns[3].classList.add('table-primary');
                        columns[4].classList.add('table-success');
                        columns[5].classList.add('table-success');
                        columns[6].classList.add('table-success');
                        columns[7].classList.add('table-info');
                        columns[8].classList.add('table-info');
                        columns[9].classList.add('table-info');

                        enrollmentTable.classList.add('table-bordered');
                        enrollmentTable.classList.add('border-secondary');
                    });
                };
                reader.readAsText(csvFile);
            }

            function dropHandler(evt) {
                if (evt.dataTransfer.items) {
                    // Use DataTransferItemList interface to access the file(s)
                    [...evt.dataTransfer.items].forEach((item, i) => {
                        // If dropped items aren't files, reject them
                        if (item.kind === "file") {
                            const file = item.getAsFile();
                            processFile(file);
                        }
                    });
                } else {
                    // use DataTransfer interface to access the file(s)
                    [...evt.dataTransfer.files].forEach((file, i) => {
                        processFile(file);
                    });
                }
            }

            function selectFileHandler(evt) {
                if (this.files.length > 0) {
                    processFile(this.files[0]);
                }
            }

            // prevent default action
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            // add event listeners
            dropArea.addEventListener('drop', dropHandler, false);
            document.getElementById('selectCsvFile').addEventListener('change', selectFileHandler, false);
            document.getElementById('exportData').addEventListener('click', exportToFile, false);
        </script>
    </body>
</html>